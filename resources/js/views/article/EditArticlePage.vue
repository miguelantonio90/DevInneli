<template>
  <div class="page-add-product">
    <v-container>
      <v-card>
        <v-card-title>
          <span class="headline">{{
            $vuetify.lang.t('$vuetify.titles.edit', [
              $vuetify.lang.t('$vuetify.articles.name'),
            ])
          }}</span>
        </v-card-title>
        <v-card-text>
          <v-form
            v-if="validShow"
            ref="form"
            v-model="formValid"
            style="padding: 0"
            lazy-validation
          >
            <v-expansion-panels
              v-model="panel"
              style="margin: 0"
              multiple
            >
              <v-expansion-panel style="margin: 0">
                <v-expansion-panel-header>
                  <h3>
                    {{
                      $vuetify.lang.t('$vuetify.panel.basic')
                    }}
                  </h3>
                </v-expansion-panel-header>
                <v-expansion-panel-content>
                  <v-row>
                    <v-col
                      cols="12"
                      md="4"
                    >
                      <v-text-field
                        v-model="editArticle.name"
                        :label="$vuetify.lang.t('$vuetify.firstName')"
                        :rules="formRule.firstName"
                        required
                      />
                    </v-col>
                    <v-col
                      cols="12"
                      md="4"
                    >
                      <v-text-field
                        v-model="editArticle.barCode"
                        :label="$vuetify.lang.t('$vuetify.barCode')"
                        required
                      />
                    </v-col>
                    <v-col
                      cols="12"
                      md="4"
                    >
                      <v-text-field
                        v-model="editArticle.price"
                        :label="$vuetify.lang.t('$vuetify.price')"
                        autocomplete="off"
                        required
                      />
                    </v-col>
                    <v-col
                      cols="12"
                      md="4"
                    >
                      <v-text-field
                        v-model="editArticle.cost"
                        :label="$vuetify.lang.t('$vuetify.articles.cost')"
                        autocomplete="off"
                        required
                      />
                    </v-col>
                    <v-col
                      cols="12"
                      md="4"
                    >
                      <v-select
                        v-model="editArticle.category"
                        :items="categories"
                        :label="$vuetify.lang.t('$vuetify.menu.category')"
                        item-text="name"
                        :loading="isShopLoading"
                        :disabled="!!isShopLoading"
                        return-object
                      />
                    </v-col>
                    <v-col
                      cols="12"
                      md="4"
                    >
                      <h4>{{ $vuetify.lang.t('$vuetify.articles.sell_by') }}</h4>
                      <v-radio-group
                        v-model="editArticle.unit"
                        row
                      >
                        <v-radio
                          :label="$vuetify.lang.t('$vuetify.articles.unit')"
                          value="unit"
                        />
                        <v-radio
                          :label="$vuetify.lang.t('$vuetify.articles.p_v')"
                          value="vol"
                        />
                      </v-radio-group>
                    </v-col>
                  </v-row>
                </v-expansion-panel-content>
              </v-expansion-panel>
              <v-expansion-panel>
                <v-expansion-panel-header>
                  <h3>{{ $vuetify.lang.t('$vuetify.articles.inventory') }}</h3>
                </v-expansion-panel-header>
                <v-expansion-panel-content>
                  <v-row>
                    <v-col
                      cols="12"
                      md="3"
                    >
                      <v-checkbox
                        v-model="editArticle.composite"
                        :disabled="articles.length===0"
                        :title="$vuetify.lang.t('$vuetify.articles.composite_text')"
                        :label="$vuetify.lang.t('$vuetify.articles.composite')"
                        @change="changeComposite"
                      />
                    </v-col>
                    <v-col
                      cols="12"
                      md="3"
                      style=" padding-top: 0;padding-left: 0;padding-bottom: 0;margin-top: 25px;"
                    >
                      <v-tooltip
                        right
                        class="md-6"
                      >
                        <template v-slot:activator="{ on, attrs }">
                          <v-icon
                            color="primary"
                            dark
                            v-bind="attrs"
                            v-on="on"
                          >
                            mdi-information-outline
                          </v-icon>
                        </template>
                        <span>{{ $vuetify.lang.t('$vuetify.articles.composite_text') }}</span>
                      </v-tooltip>
                    </v-col>
                    <v-col
                      cols="12"
                      md="3"
                    >
                      <v-checkbox
                        v-model="editArticle.track_inventory"
                        class="md-6"
                        :label="$vuetify.lang.t('$vuetify.articles.track_inventory')"
                      />
                    </v-col>
                  </v-row>
                  <v-row v-show="editArticle.composite">
                    <v-col
                      cols="12"
                      md="12"
                    >
                      <v-select
                        :items="articles"
                        :label="$vuetify.lang.t('$vuetify.rule.select')"
                        item-text="name"
                        :loading="isShopLoading"
                        :disabled="!!isShopLoading"
                        return-object
                      />
                    </v-col>
                  </v-row>
                </v-expansion-panel-content>
              </v-expansion-panel>
              <v-expansion-panel v-show="!editArticle.composite">
                <v-expansion-panel-header>
                  <h3>
                    {{
                      $vuetify.lang.t('$vuetify.panel.variant')
                    }}
                  </h3>
                </v-expansion-panel-header>
                <v-expansion-panel-content>
                  <v-row>
                    <v-col
                      cols="12"
                      md="12"
                    >
                      <v-row>
                        <v-col
                          cols="12"
                          md="12"
                        >
                          <variant :updated="updated" :variants-parent="editArticle.variants"
                            :variants-values-parent="editArticle.variants_values" @updateVariants="updateVariant"/>
                        </v-col>
                      </v-row>
                    </v-col>
                  </v-row>
                </v-expansion-panel-content>
              </v-expansion-panel>
              <v-expansion-panel>
                <v-expansion-panel-header>
                  <h3>
                    {{
                      $vuetify.lang.t('$vuetify.menu.shop')
                    }}
                  </h3>
                </v-expansion-panel-header>
                <v-expansion-panel-content>
                  <v-row>
                    <v-col
                      cols="12"
                      md="12"
                    >
                      <v-row>
                        <v-col
                          cols="12"
                          md="12"
                        >
                          <shops-articles :folow_inventory="editArticle.track_inventory"
                            :shop-data="editArticle.variants_shops"
                            :variants-data="editArticle.variants_values"
                            @updateShopsData="updateShopData"
                          />
                        </v-col>
                      </v-row>
                    </v-col>
                  </v-row>
                </v-expansion-panel-content>
              </v-expansion-panel>
            </v-expansion-panels>
          </v-form>
          <div v-if="!validShow">
            <div v-if="shops.length === 0">
              <p>
                {{
                  this.$vuetify.lang.t(
                    '$vuetify.messages.warning_create', [
                      this.$vuetify.lang.t('$vuetify.menu.shop')
                    ]
                  )
                }}
              </p>
            </div>
          </div>
        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <v-btn
            class="mb-2"
            color="error"
            @click="$router.push({name:'product_list'})"
          >
            <v-icon>mdi-close</v-icon>
            {{ $vuetify.lang.t('$vuetify.actions.cancel') }}
          </v-btn>
          <v-btn
            class="mb-2"
            color="primary"
            @click="createNewArticle"
          >
            <v-icon>mdi-check</v-icon>
            {{ $vuetify.lang.t('$vuetify.actions.save') }}
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-container>
  </div>
</template>

<script>
import ShopsArticles from './shop/ShopsArticles'
import Variant from './variants/Variant'
import { mapActions, mapState } from 'vuex'

export default {
  name: 'EditArticlePage',
  components: { ShopsArticles, Variant },
  data () {
    return {
      row: null,
      panel: [0, 1, 2],
      formValid: false,
      formRule: this.$rules,
      shopData: [],
      variantData: [],
      updated: true
    }
  },
  computed: {
    ...mapState('article', ['saved', 'editArticle', 'articles']),
    ...mapState('category', ['categories', 'isActionInProgress']),
    ...mapState('shop', ['shops', 'isShopLoading']),
    validShow () {
      return (this.shops.length > 0)
    }
  },
  mounted () {
    this.getCategories()
    this.getShops().then(() => {
      this.shops.forEach((shop) => {
        this.shopData.push({
          shop_id: shop.id,
          name: shop.name,
          checked: true,
          variant: '',
          price: '0.00',
          stock: '',
          under_inventory: ''
        })
      })
    })
    this.getArticles()
    console.log(this.editArticle)
  },
  created () {
    this.formValid = false
    this.getCategories()
    this.getShops()
  },
  methods: {
    ...mapActions('article', ['createArticle', 'toogleNewModal', 'getArticles']),
    ...mapActions('category', ['getCategories']),
    ...mapActions('shop', ['getShops']),
    changeComposite () {
      if (this.editArticle.composite) {
        this.variantData = []
      } else {
        this.updated = false
      }
    },
    updateVariant (variants, dataUpdated) {
      this.variantData = dataUpdated
      this.editArticle.variants = variants
      this.shopData = []
      this.shops.forEach((shop) => {
        console.log(variants.length)
        if (variants.length > 0) {
          this.variantData.forEach((v) => {
            this.shopData.push({
              shop_id: shop.id,
              name: shop.name,
              checked: true,
              variant: v.name,
              price: v.price,
              stock: '0',
              under_inventory: '0'
            })
          })
        } else {
          this.shopData.push({
            shop_id: shop.id,
            name: shop.name,
            checked: true,
            variant: '',
            price: '0.00',
            stock: '',
            under_inventory: ''
          })
        }
      })
      this.updated = true
    },
    updateShopData (shopsDataUpdated) {
      this.shopData = shopsDataUpdated
    },
    numbers (event) {
      const regex = new RegExp('^[0-9]+$')
      const key = String.fromCharCode(
        !event.charCode ? event.which : event.charCode
      )
      if (!regex.test(key)) {
        event.preventDefault()
        return false
      }
    },
    lettersNumbers (event) {
      const regex = new RegExp('^[a-zA-Z0-9 ]+$')
      const key = String.fromCharCode(
        !event.charCode ? event.which : event.charCode
      )
      if (!regex.test(key)) {
        event.preventDefault()
        return false
      }
    },
    async createNewArticle () {
      if (this.validShow) {
        if (this.$refs.form.validate()) {
          this.loading = true
          this.editArticle.shops = []
          this.shopData.forEach((value, index) => {
            if (value.checked) {
              this.editArticle.shops.push(value)
            }
          })
          this.editArticle.variantsValues = this.variantData
          await this.createArticle(this.editArticle).then(() => {
            if (this.saved) {
              this.loading = false
              const msg = this.$vuetify.lang.t(
                '$vuetify.messages.success_profile'
              )
              this.$Toast.fire({
                icon: 'success',
                title: msg
              })
              this.$router.push({ name: 'product_list' })
            }
          })
        }
      }
    }
  }
}
</script>

<style scoped>

</style>
